---
- name: Backup original nginx.conf
  copy:
    src: /etc/nginx/nginx.conf
    dest: /etc/nginx/nginx.conf.backup
    remote_src: yes
    force: no

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Deploy Nginx site configuration
  template:
    src: nginx-site.conf.j2
    dest: /etc/nginx/sites-available/rainomalabra
    owner: root
    group: "{{ nginx_user_group }}"
    mode: '0664'
  notify: restart nginx

- name: Deploy Nginx site configuration
  template:
    src: nginx-site.conf.j2
    dest: /etc/nginx/sites-available/rainomalabra
  register: nginx_template_result

- name: Check if site config was created
  stat:
    path: /etc/nginx/sites-available/rainomalabra
  register: site_config_stat

- name: Enable Nginx site
  file:
    src: /etc/nginx/sites-available/rainomalabra
    dest: /etc/nginx/sites-enabled/rainomalabra
    state: link
  notify: restart nginx

- name: Test Nginx configuration
  command: nginx -t
  register: nginx_test
  changed_when: false
  failed_when: nginx_test.rc != 0

# - name: Ensure Nginx is started and enabled
#   systemd:
#     name: nginx
#     state: started
#     enabled: yes

