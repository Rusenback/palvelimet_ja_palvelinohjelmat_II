---
- name: Create SSL base directory
  file:
    path: /etc/ssl/rainomalabra
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create SSL certs directory
  file:
    path: "{{ ssl_cert_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create SSL private directory
  file:
    path: "{{ ssl_key_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Check if SSL certificate exists
  stat:
    path: "{{ ssl_cert_file }}"
  register: ssl_cert_stat

- name: Generate self-signed SSL certificate
  command: >
    openssl req -x509 -nodes -days {{ ssl_validity_days }}
    -newkey rsa:2048
    -keyout {{ ssl_key_file }}
    -out {{ ssl_cert_file }}
    -subj "/C={{ ssl_country }}/ST={{ ssl_state }}/L={{ ssl_locality }}/O={{ ssl_organization }}/OU={{ ssl_organizational_unit }}/CN={{ ssl_common_name }}"
  when: not ssl_cert_stat.stat.exists

- name: Set permissions on SSL private key (readable only by root)
  file: 
    path: "{{ ssl_cert_file }}"
    owner: root
    group: root
    mode: '0644'

- name: Set permission on SSL private key (readable only by root)
  file:
    path: "{{ ssl_key_file }}"
    owner: root
    group: root
    mode: '0600'

- name: Verify developers cannot read private key
  file: 
    path: "{{ ssl_key_dir }}"
    owner: root
    group: root
    mode: '0700'
