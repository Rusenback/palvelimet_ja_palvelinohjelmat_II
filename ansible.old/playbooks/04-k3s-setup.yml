---
- name: Setup K3s Kubernetes cluster
  hosts: servers
  become: yes
  vars:
    dns_domain: rainomalabra.local
  
  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
  
  roles:
    - k3s
  
  post_tasks:
    - name: Display cluster information (master only)
      block:
        - name: Get cluster nodes
          command: k3s kubectl get nodes -o wide
          register: k3s_nodes
          changed_when: false
        
        - name: Display nodes
          debug:
            var: k3s_nodes.stdout_lines
        
        - name: Get pods in web namespace
          command: k3s kubectl get pods -n web -o wide
          register: k3s_pods
          changed_when: false
        
        - name: Display pods
          debug:
            var: k3s_pods.stdout_lines
        
        - name: Get services
          command: k3s kubectl get svc -n web
          register: k3s_services
          changed_when: false
        
        - name: Display services
          debug:
            var: k3s_services.stdout_lines
        
        - name: Display access information
          debug:
            msg:
              - "Kubernetes cluster setup complete!"
              - "Master node: server1 ({{ hostvars['server1']['ansible_host'] }})"
              - "Worker node: server2 ({{ hostvars['server2']['ansible_host'] }})"
              - "Access web application:"
              - "  HTTP:  http://{{ hostvars['server1']['ansible_host'] }}:30080"
              - "  HTTPS: https://{{ hostvars['server1']['ansible_host'] }}:30443"
              - "Kubectl commands on server1:"
              - "  k3s kubectl get nodes"
              - "  k3s kubectl get pods -n web"
              - "  k3s kubectl logs -n web <pod-name>"
      when: "'managers' in group_names"
      run_once: true
